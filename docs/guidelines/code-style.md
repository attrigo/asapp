# Code Style & Build

## Quick Reference

**Formatting**: Spotless with Eclipse formatter (`asapp_formatter.xml`)
**Import Order**: `java|javax`, `org`, `com`, blank, `com.bcn`
**Line Endings**: UNIX (LF only)
**License**: Apache 2.0 header required

**Build**:
- `mvn clean install` - Build all modules
- `mvn clean verify` - Build + tests + coverage + javadoc
- `mvn spring-boot:build-image` - Build Docker images
- `docker-compose up -d` - Start all services

**Git Hooks** (auto-installed on `mvn install`):
- **pre-commit**: Checks code style + line endings
- **commit-msg**: Validates conventional commit format

**Commit Format**: `<type>(<scope>): <description>`
**Types**: feat, fix, chore, docs, test, refactor, ci, build, perf, revert, style

## Key Patterns

### Annotation Ordering (Non-Test Classes)
1. Component Role: `@Controller`, `@Service`, `@Entity`
2. Configuration/Routing: `@RequestMapping`, `@Scope`, `@Profile`
3. API Documentation: `@Tag`, `@Operation`, `@Schema`
4. Security: `@PreAuthorize`, `@Secured`
5. Transaction/Caching: `@Transactional`, `@Cacheable`
6. Persistence: `@Table`, `@Id`, `@Column`
7. Serialization: `@JsonProperty`, `@JsonIgnore`
8. Validation: `@NotNull`, `@Size`, `@Valid`
9. Mapping: `@Mapping`, `@InheritInverseConfiguration`
10. Code Generation: `@Data`, `@Builder`

### Annotation Ordering (Test Classes)
1. Test Context: `@SpringBootTest`, `@WebMvcTest`, `@DataJdbcTest`, `@Import`
2. Infrastructure: `@Testcontainers`, `@Container`
3. Mocking: `@MockBean`, `@Mock`, `@InjectMocks`
4. Test Markers: `@Test`, `@Nested`, `@ParameterizedTest`

### Javadoc Guidelines

**Required Tags**:
- **`@since`**: MUST include on all classes, pointing to the POM version of the appropriate module (e.g., `@since 0.2.0`)
- **`@see`**: Use ONLY for references to framework classes (Spring, MapStruct, etc.), NEVER for internal project classes

**What to document**:
- All public classes and interfaces
- All public methods with complex logic
- Method parameters using `@param`
- Return values using `@return`
- Exceptions using `@throws`

**Best Practices**:
- Start descriptions with a verb (e.g., "Stores JWT tokens...")
- Use `{@link}` for internal references in descriptions only
- Keep `@see` references for framework classes
- Update `@since` when adding new classes to match current module version

### Commit Message Examples
```
feat: add user authentication
feat(api): add refresh token endpoint
fix(users): resolve null pointer in update
docs: update architecture documentation
test(authentication): add JWT validation tests
refactor: simplify token generation logic
chore: update dependencies
```

### Build Commands
```bash
# Build and test
mvn clean verify

# Run specific service
cd services/asapp-authentication-service && mvn spring-boot:run

# Docker
mvn spring-boot:build-image
docker-compose up -d
docker-compose logs -f asapp-authentication-service
docker-compose down -v
```

## Details

### Spotless Configuration

**Plugin**: `spotless-maven-plugin`
**Formatter**: `asapp_formatter.xml` (Eclipse formatter)
**License Header**: `header-license` file

**Commands**:
```bash
mvn spotless:check   # Check formatting
mvn spotless:apply   # Fix formatting
```

**Pre-commit Hook**: Automatically runs `spotless:check` before commit

### Git Hooks

**pre-commit Hook** (`git/hooks/pre-commit`):
- Runs `mvn spotless:check` for code formatting
- Validates staged files use LF line endings (not CRLF)
- Blocks commit if checks fail
- Supported extensions: java, xml, yml, properties, md, sh, sql, json, etc.

**commit-msg Hook** (`git/hooks/commit-msg`):
- Validates commit message format
- Regex: `^(build|chore|ci|docs|feat|fix|perf|refactor|revert|style|test)(\([a-z \-]+\))?!?: .+$`
- Blocks commit if format invalid
- Reference: https://www.conventionalcommits.org/

**Installation**: Automatic via `mvn install` or manually via `mvn git-build-hook:install`

### Build Artifacts

**Generated by `mvn verify`**:
1. Main JAR: `<artifact>-<version>.jar`
2. Javadoc JAR: `<artifact>-<version>-javadoc.jar` (API docs)
3. Sources JAR: `<artifact>-<version>-sources.jar` (source code)

**Skip javadoc/sources** (faster build):
```bash
mvn install -Dmaven.javadoc.skip=true -Dmaven.source.skip=true
```

### Database Commands (Liquibase)

```bash
cd services/asapp-authentication-service
mvn liquibase:updateSQL          # Generate migration SQL
mvn liquibase:clearCheckSums     # Clear checksums
mvn liquibase:rollback -Dliquibase.rollbackCount=1  # Rollback
```

### Accessing Services

**Applications**:
- Authentication: `http://localhost:8080/asapp-authentication-service`
- Users: `http://localhost:8082/asapp-users-service`
- Tasks: `http://localhost:8081/asapp-tasks-service`

**Swagger UI**: Append `/swagger-ui.html` to any service URL

**Actuator** (management ports):
- Authentication: `http://localhost:8090/asapp-authentication-service/actuator`
- Tasks: `http://localhost:8091/asapp-tasks-service/actuator`
- Users: `http://localhost:8092/asapp-users-service/actuator`

**Monitoring**:
- Prometheus: `http://localhost:9090`
- Grafana: `http://localhost:3000` (admin/secret)

### Technology Stack

- Java 21, Spring Boot 3.4.3
- Database: PostgreSQL + Liquibase
- Security: Spring Security + JWT (JJWT)
- Mapping: MapStruct 1.6.3
- Testing: JUnit 5, AssertJ, TestContainers, MockServer
- Quality: Spotless, JaCoCo, PITest
- Docs: SpringDoc OpenAPI 2.8.5
- Observability: Actuator, Prometheus, Grafana
